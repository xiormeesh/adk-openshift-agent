# ADK OpenShift Agent - Backend

FastAPI backend using Google's Agent Development Kit (ADK) to provide AI-powered Kubernetes/OpenShift cluster management.

## Architecture

```
Frontend (CopilotKit) -> Next.js API Route (/api/copilotkit)
                      -> HttpAgent (@ag-ui/client)
                      -> AG-UI Protocol
                      -> Backend (add_adk_fastapi_endpoint)
                      -> ADK Agent
                      -> OpenAI (via LiteLLM)
                      -> [Future: Kubernetes MCP Tools]
```

## Quick Start

### Prerequisites

- Python 3.12
- Poetry
- OpenAI API key
- Node.js 24 (for npx, when enabling MCP tools)

### Setup

1. Install dependencies:
```bash
poetry install
```

2. Create `.env` file:
```bash
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4-turbo-preview
CORS_ORIGINS=http://localhost:8080
```

3. Run development server:
```bash
poetry run dev
```

Server runs on http://localhost:8000

## Testing

### Test AG-UI Agent Discovery

```bash
# Check if agent is exposed correctly
curl http://localhost:8000/info
```

Expected response:
```json
{
  "agents": ["openshift_assistant"],
  ...
}
```

### Test Health Endpoints

```bash
# Basic health check
curl http://localhost:8000/

# Detailed health check
curl http://localhost:8000/health
```

### Test with ADK Web Interface

```bash
# Start ADK's built-in web UI (different from CopilotKit)
cd backend
poetry run adk web . --port 9999
```

Then open http://localhost:9999

### Full Integration Test

The agent is designed to work with CopilotKit frontend:

1. Start backend: `poetry run dev` (runs on :8000)
2. Start frontend: `cd ../frontend && npm run dev` (runs on :8080)
3. Open http://localhost:8080
4. Test chat in popup

**Note:** Direct curl tests of the AG-UI POST endpoint are complex due to the protocol format. Use the frontend or ADK web interface for testing.

## Project Structure

```
backend/
├── agent/
│   └── agent.py     # ADK agent configuration with root_agent
├── main.py          # FastAPI server with AG-UI integration
├── config.py        # Configuration from environment variables
├── pyproject.toml   # Python dependencies and Poetry config
└── .env            # Environment variables (not in git)
```

## Key Files

### main.py

FastAPI application with AG-UI integration.

**Endpoints (auto-generated by AG-UI):**
- `GET /info` - Agent discovery (lists available agents)
- `POST /` - Send messages to agent via AG-UI protocol
- `WebSocket /ws` - Streaming responses (optional)

**Custom endpoints:**
- `GET /` - Basic health check (note: different from POST /)
- `GET /health` - Detailed health check

**Key code:**
```python
from ag_ui_adk import add_adk_fastapi_endpoint

add_adk_fastapi_endpoint(app, root_agent, path="/")
```

This one line exposes the entire agent via AG-UI protocol.

### agent/agent.py

Defines the ADK agent.

**Key variable:** `root_agent`
- Must be named `root_agent` (ADK convention)
- Uses LiteLLM to connect to OpenAI
- Kubernetes MCP tools currently commented out (requires npx)

### config.py

Loads configuration from .env file and validates required settings.

## Current Status

✅ **Working:**
- FastAPI server with AG-UI protocol
- ADK + OpenAI integration via LiteLLM
- CopilotKit frontend integration
- Basic Q&A about Kubernetes/OpenShift

❌ **Not Yet Working:**
- Kubernetes MCP tools (requires npx to be installed)
- Direct cluster interaction

## How It Works

### AG-UI Integration (Current Approach)

The backend uses `add_adk_fastapi_endpoint()` which automatically:
1. Exposes the agent via AG-UI protocol
2. Creates `/info` endpoint for agent discovery
3. Handles conversation state management
4. Streams responses to frontend
5. No manual session management needed

**Code:**
```python
from ag_ui_adk import ADKAgent, add_adk_fastapi_endpoint
from agent import root_agent

# Wrap the agent with AG-UI middleware
adk_agent = ADKAgent(
    adk_agent=root_agent,
    app_name="openshift_assistant",
    user_id="default_user",
    session_timeout_seconds=3600,
    use_in_memory_services=True
)

add_adk_fastapi_endpoint(app, adk_agent, path="/")
```

That's it! No manual endpoints, minimal configuration code.

### Critical Details

1. **Agent must be named `root_agent`** - ADK convention for AG-UI
2. **Agent must be wrapped with `ADKAgent`** - Required for AG-UI protocol compatibility
3. **Agent name in code must match frontend** - Both use "openshift_assistant"
4. **CORS must allow frontend origin** - Set to http://localhost:8080
5. **Minimal configuration** - `add_adk_fastapi_endpoint()` handles all protocol details

## Enabling Kubernetes MCP Tools

To enable direct cluster interaction:

1. Verify npx is installed (comes with Node.js 24):
```bash
which npx
```

2. Uncomment in `agent/agent.py`:
   - Lines 33-35: MCP imports
   - Lines 41-54: kubernetes_toolset configuration
   - Line 78: tools=[kubernetes_toolset]

3. Restart server - MCP server will connect via stdio

## Dependencies

Key Python packages (managed by Poetry):

- `fastapi` - Web framework
- `uvicorn` - ASGI server
- `google-adk` - Agent Development Kit
- `ag-ui-adk` - AG-UI protocol server for ADK
- `litellm` - OpenAI adapter for ADK
- `openai` - OpenAI SDK
- `pydantic` - Data validation
- `python-dotenv` - Environment variables

## Development Commands

```bash
# Install dependencies
poetry install

# Run dev server (auto-reload enabled)
poetry run dev

# Run ADK web interface for testing
poetry run adk web . --port 9999

# Check Python version
poetry run python --version

# View dependencies
poetry show

# Update dependencies
poetry update
```

## Troubleshooting

### "Agent not found after runtime sync"

**Cause:** Frontend can't discover the agent.

**Fix:**
1. Check backend is running on :8000
2. Verify `add_adk_fastapi_endpoint(app, root_agent, path="/")` is called
3. Test agent discovery: `curl http://localhost:8000/info`
4. Check agent name matches in frontend and backend
5. Verify CORS allows frontend origin

### "ModuleNotFoundError: No module named 'ag_ui_adk'"

**Cause:** AG-UI package not installed.

**Fix:**
```bash
poetry install
```

### MCP connection error

**Cause:** MCP tool server not running or npx not installed.

**Fix:**
- Check if npx is installed: `which npx`
- Verify MCP tools are commented out in `agent/agent.py`
- Install Node.js 24 if needed

### Import errors in IDE

**Cause:** IDE doesn't see Poetry virtualenv.

**Fix:**
- Ignore IDE errors - run with `poetry run`
- Commands will work even if IDE shows red squiggles
- Restart TypeScript server in IDE if needed

## Architecture Details

### Why AG-UI?

**Problem:** ADK agents are Python, frontends are JavaScript. How do they communicate?

**Solution:** AG-UI is an open protocol that:
- Standardizes agent-frontend communication
- Handles session management automatically
- Supports streaming responses
- Works with any frontend framework (React, Vue, etc.)

### How Frontend Connects

Frontend uses `HttpAgent` from `@ag-ui/client`:

```typescript
import { HttpAgent } from "@ag-ui/client";

const runtime = new CopilotRuntime({
  agents: {
    openshift_assistant: new HttpAgent({ url: "http://localhost:8000/" })
  }
});
```

This discovers and connects to the agent automatically.

## What Changed Recently

This codebase was recently refactored to use AG-UI:

**Removed (old approach):**
- ❌ Manual `/copilotkit` endpoint
- ❌ Manual session management code
- ❌ `Runner` and `InMemorySessionService` usage
- ❌ `/chat` and `/ws/chat` endpoints

**Added (new approach):**
- ✅ `ag-ui-adk` package
- ✅ `add_adk_fastapi_endpoint()` - one-line integration
- ✅ Automatic AG-UI protocol endpoints

**Result:** Simpler, cleaner code that follows ADK best practices.

## Additional Resources

- **Complete Tech Stack Docs:** See `TECH_STACK.md` in project root
- **ADK Documentation:** https://google.github.io/adk-docs/
- **AG-UI Documentation:** https://google.github.io/adk-docs/tools/third-party/ag-ui/
- **CopilotKit + ADK Guide:** https://docs.copilotkit.ai/adk
